# Validate Content PRs
#
# Ensures content follows the composable design:
# - Assets must use full CDN URLs (uploaded by author/agent)
# - Local asset references (/img/, /slides/) are rejected
#
# This enforces clean separation between content (managed in git)
# and assets (managed in CDN by authors/agents).

name: Validate Content

on:
  pull_request:
    paths:
      - "book-source/docs/**"

jobs:
  validate:
    name: Check Asset References
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for local asset references
        run: |
          echo "Checking for local asset references in markdown files..."
          echo "Assets should use full CDN URLs, not local paths."
          echo ""

          # Find markdown files with local asset references
          # Patterns to reject:
          # - ![...](/img/...)
          # - ![...](/slides/...)
          # - src="/img/..." or src='/img/...'
          # - source: "slides/..." in frontmatter

          ERRORS=0

          # Check for /img/ references in markdown images
          if grep -rn '!\[.*\](/img/' book-source/docs/ 2>/dev/null; then
            echo ""
            echo "ERROR: Found local /img/ references. Use CDN URLs instead."
            echo "  Example: ![alt](https://cdn.example.com/images/file.png)"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for /slides/ references in markdown images
          if grep -rn '!\[.*\](/slides/' book-source/docs/ 2>/dev/null; then
            echo ""
            echo "ERROR: Found local /slides/ references. Use CDN URLs instead."
            ERRORS=$((ERRORS + 1))
          fi

          # Check for src="/img/ or src='/img/ in HTML
          if grep -rn 'src=["\x27]/img/' book-source/docs/ 2>/dev/null; then
            echo ""
            echo "ERROR: Found local /img/ in HTML src attributes. Use CDN URLs."
            ERRORS=$((ERRORS + 1))
          fi

          # Summary
          echo ""
          if [ $ERRORS -eq 0 ]; then
            echo "✓ All asset references are valid (no local paths found)"
          else
            echo "✗ Found $ERRORS type(s) of local asset references"
            echo ""
            echo "How to fix:"
            echo "1. Upload your assets to CDN (ask your agent to help)"
            echo "2. Replace local paths with full CDN URLs"
            echo "   Before: ![diagram](/img/chapter-5/diagram.png)"
            echo "   After:  ![diagram](https://cdn.panaversity.org/images/chapter-5/diagram.png)"
            exit 1
          fi
